---
title: "Share_Class"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Adrian D. Garcia"
date: "January 2020"
output: html_document
---

```{r setup, message=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(DT)
```

```{r data, message=FALSE}

INCEPTION <- read_excel(path = "launch-liquidation-data-for-adrian.xlsx", sheet = 1, na = "")

PATTERN <- c("(\\s)?([:alnum:]+)?( Load Waived)?( LW)?([:punct:]+)?([:alnum:]+)?(-[:alnum:])?(â„¢)?([:alpha:]\\{..\\} LW)?([:punct:]..[:punct:])?(\\s)?([:punct:][:alpha:]+[:punct:])?$")

CUT <- c("([:punct:]\\X\\X[:punct:])|([:punct:]\\X\\X$)|(-)|(\\sLW)|(\\sLoad\\sWaived)|(\\([:alpha:]+\\))")

CHANGE <- c("^Adm(in$)?(in[:alpha:]+)?$" = "Admin",
            "[:alnum:]+R6$" = "R6",
            "(?!AA)[:alpha:]+A$" = "A",
            "(?![FIVS]+I$|([:alpha:]+)?II$)([:alpha:]+)?I$" = "I",
            "([:alpha:]+)?C$" = "C",
            "([:alpha:]+)?Inst(l$)?(itutional$)?$" = "Instl",
            "([:alpha:]+)?(\\:[:alpha:]+)?Y$" = "Y",
            "([:alpha:]+)?(\\:[:alpha:]+)?R$(?<!(SDR$))" = "R")

Data <- INCEPTION %>%  
  select(Name) %>% 
  mutate(
    Match = str_detect(Name, PATTERN),
    EXTRACT = str_extract(Name, PATTERN),
    New=str_trim(str_replace_all(EXTRACT,  CUT, ""))
  ) %>% 
  mutate(
    Revision = str_replace_all(New, CHANGE)
    )
```

```{r data_show, echo=FALSE}
datatable(Data, options = list(autoWidth = TRUE, scrollX = TRUE))
```

```{r summary, message=FALSE}
ChangesSummaryTable <- Data %>%
  group_by(EXTRACT) %>% 
  summarise(cases = n()) %>%
  mutate(
    New=str_trim(str_replace_all(EXTRACT,  CUT, ""))
  ) %>% group_by(New) %>% 
  mutate(replacements=n()-1,
         newcases = sum(cases)) %>%
  mutate(Revision = str_replace_all(New, CHANGE)
  )%>% 
  group_by(Revision) %>% 
  mutate(replacements1=(n()-replacements)-1,
         newercases = sum(cases)
         )

SummaryTable <- Data %>%
  group_by(Revision) %>% 
  summarise(cases = n()) %>% 
  arrange(-cases)
```

```{r changes_summary_show, echo=FALSE}
datatable(ChangesSummaryTable)
```

```{r add, message=FALSE}
MODIFIED <- INCEPTION %>%  
  mutate(
    Match = str_detect(Name, PATTERN),
    EXTRACT = str_extract(Name, PATTERN),
    New=str_trim(str_replace_all(EXTRACT,  CUT, ""))    ) %>% 
  select(Name, Match, EXTRACT, New, 2:19)
         
```

```{r summary_show, echo=FALSE}
datatable(SummaryTable)
```